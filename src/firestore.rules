rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================================
    // HELPER FUNCTIONS
    // ============================================================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Get user role from users collection
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    // Check if user is an admin
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }
    
    // Check if user is a teacher
    function isTeacher() {
      return isAuthenticated() && getUserRole() == 'teacher';
    }
    
    // Check if user is a student
    function isStudent() {
      return isAuthenticated() && getUserRole() == 'student';
    }
    
    // Check if user is teacher or admin
    function isTeacherOrAdmin() {
      return isTeacher() || isAdmin();
    }
    
    // Check if user owns the resource (created by them)
    function isOwner(resourceData) {
      return isAuthenticated() && resourceData.createdBy == request.auth.uid;
    }
    
    // Check if user is the resource owner or an admin/teacher
    function isOwnerOrTeacherOrAdmin(resourceData) {
      return isTeacherOrAdmin() || isOwner(resourceData);
    }
    
    // Check if incoming data has required fields
    function hasRequiredFields(requiredFields) {
      return request.resource.data.keys().hasAll(requiredFields);
    }
    
    // Validate timestamp is server timestamp
    function isValidTimestamp(field) {
      return request.resource.data[field] == request.time;
    }
    
    // Check if student is enrolled in a course (with approved status)
    function isEnrolledInCourse(courseId) {
      return exists(/databases/$(database)/documents/enrollments/$(request.auth.uid + '_' + courseId)) ||
             existsAfter(/databases/$(database)/documents/enrollments/$(request.auth.uid + '_' + courseId));
    }
    
    
    // ============================================================================
    // USERS COLLECTION
    // ============================================================================
    match /users/{userId} {
      // Anyone can read their own user document
      // Admins and teachers can read all user documents
      allow read: if isAuthenticated() && 
                     (request.auth.uid == userId || isTeacherOrAdmin());
      
      // Users can create their own document during registration
      // Admins and teachers can create documents for other users
      allow create: if isAuthenticated() && 
                       (request.auth.uid == userId || isTeacherOrAdmin()) &&
                       hasRequiredFields(['email', 'role', 'createdAt']);
      
      // Users can update their own profile (except role field)
      // Admins and teachers can update any user document including roles
      allow update: if isAuthenticated() && 
                       ((request.auth.uid == userId && 
                         !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role'])) ||
                        isTeacherOrAdmin());
      
      // Admins and teachers can delete user documents
      allow delete: if isTeacherOrAdmin();
    }
    
    
    // ============================================================================
    // COURSES COLLECTION
    // ============================================================================
    match /courses/{courseId} {
      // All authenticated users can read courses
      allow read: if isAuthenticated();
      
      // Teachers and admins can create courses
      allow create: if isTeacherOrAdmin() &&
                       hasRequiredFields(['title', 'description', 'category', 'difficulty', 
                                        'duration', 'createdBy', 'createdAt']) &&
                       request.resource.data.createdBy == request.auth.uid;
      
      // Teachers and admins can update any course
      allow update: if isTeacherOrAdmin();
      
      // Teachers and admins can delete any course
      allow delete: if isTeacherOrAdmin();
    }
    
    
    // ============================================================================
    // ASSESSMENTS COLLECTION
    // ============================================================================
    match /assessments/{assessmentId} {
      // Teachers and admins can read all assessments
      // Students can read all assessments (they'll filter by their enrollments in the app)
      allow read: if isAuthenticated();
      
      // Teachers and admins can create assessments
      allow create: if isTeacherOrAdmin() &&
                       hasRequiredFields(['courseId', 'title', 'questions', 'timeLimit', 
                                        'totalPoints', 'createdBy', 'createdAt']) &&
                       request.resource.data.createdBy == request.auth.uid &&
                       exists(/databases/$(database)/documents/courses/$(request.resource.data.courseId));
      
      // Teachers and admins can update any assessment
      allow update: if isTeacherOrAdmin();
      
      // Teachers and admins can delete any assessment
      allow delete: if isTeacherOrAdmin();
    }
    
    
    // ============================================================================
    // ENROLLMENTS COLLECTION
    // ============================================================================
    match /enrollments/{enrollmentId} {
      // Students can read their own enrollments
      // Teachers and admins can read all enrollments
      allow read: if isAuthenticated() && (
        resource.data.studentId == request.auth.uid ||
        isTeacherOrAdmin()
      );
      
      // Students can create enrollment requests
      allow create: if isStudent() &&
                       hasRequiredFields(['courseId', 'studentId', 'studentName', 'email', 
                                        'enrolledAt', 'status', 'progress']) &&
                       request.resource.data.studentId == request.auth.uid &&
                       request.resource.data.status == 'pending' &&
                       request.resource.data.progress == 0 &&
                       exists(/databases/$(database)/documents/courses/$(request.resource.data.courseId));
      
      // Students can update their own enrollment progress and completion status
      // Teachers and admins can approve/reject enrollments and update progress
      allow update: if isAuthenticated() && (
        (resource.data.studentId == request.auth.uid && 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['progress', 'lastActivity', 'completed', 'completedAt']) &&
         // Ensure completed flag matches progress status
         (!request.resource.data.keys().hasAny(['completed']) || 
          (request.resource.data.completed == true && request.resource.data.progress == 100) ||
          (request.resource.data.completed == false && request.resource.data.progress < 100))) ||
        isTeacherOrAdmin()
      );
      
      // Teachers and admins can delete enrollments
      allow delete: if isTeacherOrAdmin();
    }
    
    
    // ============================================================================
    // ASSESSMENT RESULTS COLLECTION
    // ============================================================================
    match /assessmentResults/{resultId} {
      // Students can read their own results
      // Teachers and admins can read all results
      allow read: if isAuthenticated() && (
        resource.data.studentId == request.auth.uid ||
        isTeacherOrAdmin()
      );
      
      // Students can create results for assessments
      // Validation of enrollment is done in the app layer
      allow create: if isStudent() &&
                       hasRequiredFields(['studentId', 'assessmentId', 'courseId', 'answers', 
                                        'score', 'totalPoints', 'percentage', 'completedAt']) &&
                       request.resource.data.studentId == request.auth.uid &&
                       exists(/databases/$(database)/documents/assessments/$(request.resource.data.assessmentId));
      
      // No updates allowed to assessment results (immutable records)
      allow update: if false;
      
      // Teachers and admins can delete assessment results
      allow delete: if isTeacherOrAdmin();
    }
    
    
    // ============================================================================
    // CERTIFICATES COLLECTION
    // ============================================================================
    match /certificates/{certificateId} {
      // Students can read their own certificates (pending or verified)
      // This allows them to check status and generate certificate PDFs client-side
      // Teachers and admins can read all certificates
      allow read: if isAuthenticated() && (
        resource.data.studentId == request.auth.uid ||
        isTeacherOrAdmin()
      );
      
      // Students can request certificates for completed courses
      allow create: if isStudent() &&
                       hasRequiredFields(['studentId', 'studentName', 'courseId', 'courseName', 
                                        'completedAt', 'requestedAt', 'status']) &&
                       request.resource.data.studentId == request.auth.uid &&
                       request.resource.data.status == 'pending' &&
                       exists(/databases/$(database)/documents/courses/$(request.resource.data.courseId));
      
      // Admins can verify/reject certificates
      // Students cannot update certificates
      allow update: if isAdmin() &&
                       request.resource.data.diff(resource.data).affectedKeys()
                         .hasOnly(['status', 'verifiedBy', 'verifiedAt', 'certificateNumber', 'rejectionReason']);
      
      // Admins can delete certificates
      allow delete: if isAdmin();
    }
    
    
    // ============================================================================
    // NOTIFICATIONS COLLECTION
    // ============================================================================
    match /notifications/{notificationId} {
      // Users can read their own notifications
      // Teachers and admins can read all notifications
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isTeacherOrAdmin()
      );
      
      // Teachers and admins can create notifications
      allow create: if isTeacherOrAdmin() &&
                       hasRequiredFields(['userId', 'type', 'message', 'createdAt', 'read']);
      
      // Users can update their own notifications (mark as read)
      // Teachers and admins can update any notification
      allow update: if isAuthenticated() && (
        (resource.data.userId == request.auth.uid &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read', 'readAt'])) ||
        isTeacherOrAdmin()
      );
      
      // Users can delete their own notifications
      // Teachers and admins can delete any notification
      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isTeacherOrAdmin()
      );
    }
    
    
    // ============================================================================
    // SYSTEM LOGS COLLECTION
    // ============================================================================
    match /systemLogs/{logId} {
      // Teachers and admins can read system logs
      allow read: if isTeacherOrAdmin();
      
      // Teachers and admins can create logs
      allow create: if isTeacherOrAdmin();
      
      // No updates to logs (immutable audit trail)
      allow update: if false;
      
      // Teachers and admins can delete logs
      allow delete: if isTeacherOrAdmin();
    }
    
    
    // ============================================================================
    // COURSE MATERIALS COLLECTION
    // ============================================================================
    match /courseMaterials/{materialId} {
      // Students can read all materials (filtering by enrollment is done in the app)
      // Teachers and admins can read all materials
      allow read: if isAuthenticated();
      
      // Teachers and admins can create materials for any course
      allow create: if isTeacherOrAdmin() &&
                       hasRequiredFields(['courseId', 'title', 'type', 'url', 'createdBy', 'createdAt']) &&
                       request.resource.data.createdBy == request.auth.uid &&
                       exists(/databases/$(database)/documents/courses/$(request.resource.data.courseId));
      
      // Teachers and admins can update any material
      allow update: if isTeacherOrAdmin();
      
      // Teachers and admins can delete any material
      allow delete: if isTeacherOrAdmin();
    }
    
    
    // ============================================================================
    // STUDENT PROGRESS COLLECTION
    // ============================================================================
    match /studentProgress/{progressId} {
      // Students can read their own progress
      // Teachers and admins can read all progress
      allow read: if isAuthenticated() && (
        resource.data.studentId == request.auth.uid ||
        isTeacherOrAdmin()
      );
      
      // Students can create their own progress
      allow create: if isStudent() &&
                       hasRequiredFields(['studentId', 'courseId', 'materialId', 'completed', 'lastAccessed']) &&
                       request.resource.data.studentId == request.auth.uid;
      
      // Students can update their own progress
      // Teachers and admins can update any progress
      allow update: if isAuthenticated() && (
        resource.data.studentId == request.auth.uid ||
        isTeacherOrAdmin()
      );
      
      // Teachers and admins can delete progress records
      allow delete: if isTeacherOrAdmin();
    }
    
    
    // ============================================================================
    // ANALYTICS COLLECTION
    // ============================================================================
    match /analytics/{analyticsId} {
      // Teachers and admins can read analytics
      allow read: if isTeacherOrAdmin();
      
      // Teachers and admins can create analytics
      allow create: if isTeacherOrAdmin();
      
      // Teachers and admins can update analytics
      allow update: if isTeacherOrAdmin();
      
      // Teachers and admins can delete analytics
      allow delete: if isTeacherOrAdmin();
    }
    
    
    // ============================================================================
    // COLLABORATIONS COLLECTION
    // ============================================================================
    match /collaborations/{collaborationId} {
      // Collaborators can read collaboration documents
      // Teachers and admins can read all collaborations
      allow read: if isAuthenticated() && (
        isTeacherOrAdmin() ||
        request.auth.uid in resource.data.collaborators
      );
      
      // Teachers can create collaborations
      allow create: if isTeacher() &&
                       hasRequiredFields(['courseId', 'collaborators', 'createdBy', 'createdAt']) &&
                       request.resource.data.createdBy == request.auth.uid &&
                       request.auth.uid in request.resource.data.collaborators;
      
      // Teachers and admins can update any collaboration
      allow update: if isTeacherOrAdmin();
      
      // Teachers and admins can delete any collaboration
      allow delete: if isTeacherOrAdmin();
    }
    
    
    // ============================================================================
    // BOOKMARKS COLLECTION
    // ============================================================================
    match /bookmarks/{bookmarkId} {
      // Students can read their own bookmarks
      allow read: if isStudent() && resource.data.studentId == request.auth.uid;
      
      // Students can create bookmarks
      allow create: if isStudent() &&
                       hasRequiredFields(['studentId', 'courseId', 'materialId', 'createdAt']) &&
                       request.resource.data.studentId == request.auth.uid;
      
      // Students can update their own bookmarks
      allow update: if isStudent() && resource.data.studentId == request.auth.uid;
      
      // Students can delete their own bookmarks
      allow delete: if isStudent() && resource.data.studentId == request.auth.uid;
    }
    
    
    // ============================================================================
    // DEFAULT DENY RULE
    // ============================================================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
